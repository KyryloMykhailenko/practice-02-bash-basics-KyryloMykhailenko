#!/usr/bin/env bash
set -euo pipefail

DB="${ADDRESSBOOK_DB:-addressbook.db}"

ensure_db(){ [[ -f "$DB" ]] || : >"$DB"; }

usage(){
  cat >&2 <<'EOF'
Використання:
  ./addressbook new <name> <email>
  ./addressbook list
  ./addressbook remove <name>
  ./addressbook clear
  ./addressbook lookup <name>
EOF
  exit 1
}

strip_cr(){ printf '%s' "${1//$'\r'/}"; }

cmd=${1:-}

case "$cmd" in
  new)
    [[ $# -eq 3 ]] || usage
    ensure_db
    name=$(strip_cr "$2")
    email=$(strip_cr "$3")
    printf '%s\t%s\n' "$name" "$email" >>"$DB"
    ;;

  list)
    ensure_db
    if [[ ! -s "$DB" ]]; then
      echo "Адресна книга порожня"
      exit 0
    fi
    while IFS=$'\t' read -r name email || [[ -n "${name-}" ]]; do
      name=$(strip_cr "${name-}")
      email=$(strip_cr "${email-}")
      [[ -z "$name$email" ]] && continue
      printf '%s %s\n' "$name" "$email"
    done <"$DB"
    ;;

  remove)
    [[ $# -eq 2 ]] || usage
    ensure_db
    target=$(strip_cr "$2")
    tmp=$(mktemp)
    while IFS= read -r line || [[ -n "$line" ]]; do
      line_no_cr=${line//$'\r'/}
      IFS=$'\t' read -r name email <<<"$line_no_cr"
      [[ "$name" == "$target" ]] && continue
      printf '%s\n' "$line_no_cr" >>"$tmp"
    done <"$DB"
    mv -- "$tmp" "$DB"
    ;;

  clear)
    ensure_db
    : >"$DB"
    ;;

  lookup)
    [[ $# -eq 2 ]] || usage
    ensure_db
    target=$(strip_cr "$2")
    while IFS=$'\t' read -r name email || [[ -n "${name-}" ]]; do
      name=$(strip_cr "${name-}")
      email=$(strip_cr "${email-}")
      [[ "$name" == "$target" ]] && printf '%s\n' "$email"
    done <"$DB"
    ;;

  *)
    usage
    ;;
esac
