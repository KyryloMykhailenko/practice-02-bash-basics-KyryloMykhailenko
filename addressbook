#!/usr/bin/env bash
set -euo pipefail
DB="${ADDRESSBOOK_DB:-addressbook.db}"

ensure_db() { [[ -f "$DB" ]] || : > "$DB"; }

usage() {
  cat >&2 <<'EOF'
Використання:
  ./addressbook new <name> <email>
  ./addressbook list
  ./addressbook remove <name>
  ./addressbook clear
  ./addressbook lookup <name>
EOF
  exit 1
}

clean_cr() { printf '%s' "$1" | sed 's/\r//g'; }

cmd=${1:-}
case "$cmd" in
  new)
    [[ $# -eq 3 ]] || usage
    ensure_db
    name=$(clean_cr "$2")
    email=$(clean_cr "$3")
    printf '%s\t%s\n' "$name" "$email" >> "$DB"
    ;;
  list)
    ensure_db
    if [[ ! -s "$DB" ]]; then
      echo "Адресна книга порожня"
      exit 0
    fi
    awk -F'\t' '{gsub(/\r/,"",$1); gsub(/\r/,"",$2); print $1 " " $2}' "$DB"
    ;;
  remove)
    [[ $# -eq 2 ]] || usage
    ensure_db
    name=$(clean_cr "$2")
    tmp=$(mktemp)
    awk -v n="$name" -F'\t' '{gsub(/\r/,"",$1); if ($1 != n) print $0}' "$DB" > "$tmp"
    mv -- "$tmp" "$DB"
    ;;
  clear)
    ensure_db
    : > "$DB"
    ;;
  lookup)
    [[ $# -eq 2 ]] || usage
    ensure_db
    name=$(clean_cr "$2")
    awk -v n="$name" -F'\t' '$1==n {gsub(/\r/,"",$2); print $2}' "$DB"
    ;;
  *)
    usage
    ;;
esac
